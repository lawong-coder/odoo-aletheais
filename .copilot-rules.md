# ODOO XML DEPENDENCY RULES - ALWAYS FOLLOW

## ÔøΩ FOR AI CODING AGENTS - SIMPLE VERSION:
Before editing XML or __manifest__.py files in this Odoo project:
1. Read .copilot-rules.md first
2. Run python3 scripts/validate_deps.py after changes  
3. Fix any validation errors before proceeding

## ÔøΩüö® CRITICAL RULE: Never create forward references in XML

Before editing ANY XML file or __manifest__.py:

### 1. Manifest Order (NEVER change without checking):
```python
"data": [
    "security/ir.model.access.csv",     # Security FIRST
    "data/*.csv",                       # Data files SECOND  
    "reports/*_clean.xml",              # Paper formats THIRD
    "reports/report_actions.xml",       # Report actions FOURTH
    "views/*_views.xml",                # ALL view files FIFTH (except menu)
    "views/menu.xml",                   # Menu LAST
    "data/ir_cron_data.xml",           # Cron FINAL
]
```

### 2. Before ANY XML change:
- Check: Does this XML reference something with `ref="..."` or `action="..."`?
- If YES: Ensure the referenced item is defined in a file that loads BEFORE this one
- If NO: Make the change

### 3. After ANY XML change:
```bash
docker compose restart odoo
# Test module installation - if it fails, you broke dependencies
```

### 4. Emergency fix if you break something:
```bash
git checkout HEAD -- custom-addons/*/(__manifest__.py|views/menu.xml)
docker compose restart odoo
```

## ‚ùå NEVER DO:
- Put menu.xml before other view files in manifest
- Reference an action that's defined later  
- Change manifest order without testing
- Make multiple XML changes at once

## ‚úÖ ALWAYS DO:
- Define actions BEFORE menus that reference them
- Test installation after XML changes
- One change at a time
- Keep security files first, menus last

## üéØ MENU ITEM FUNDAMENTALS CHECKLIST

Before creating/editing ANY menuitem in XML, verify ALL of these:

### 1. Action Reference Validation
```xml
<!-- ‚ùå WRONG: Referencing a view id -->
<menuitem id="menu_item" action="view_pharmaceutical_charge_tree"/>

<!-- ‚úÖ CORRECT: Referencing an action id -->
<menuitem id="menu_item" action="action_pharmaceutical_charge"/>
```
**Check**: Does `action="..."` reference an `ir.actions.act_window` record (NOT a view)?
- Use `grep -r "action_pharmaceutical_charge" custom-addons/*/views/` to find the action definition
- Verify the action exists in a file that loads BEFORE this menu file in `__manifest__.py`

### 2. Parent Menu Existence
```xml
<menuitem id="menu_item" parent="menu_nh_billing_masters"/>
```
**Check**: Does the parent menu exist?
```bash
# Database check:
docker compose exec db psql -U odoo -d demo -c \
  "SELECT id, name::text FROM ir_ui_menu WHERE name::text LIKE '%Masters%';"

# XML check:
grep -r 'id="menu_nh_billing_masters"' custom-addons/*/views/
```

### 3. Sequence Appropriateness
```xml
<menuitem sequence="7"/>  <!-- Must fit between siblings -->
```
**Check**: Does the sequence fit logically in the parent's child list?
- View existing sequences: `SELECT name::text, sequence FROM ir_ui_menu WHERE parent_id = X;`
- Typical ranges: 1-10 (top items), 10-50 (middle items), 50+ (bottom items)

### 4. Security Access Rights
```bash
# Check if model has access rules:
grep "model_nh_pharmaceutical_charge" custom-addons/*/security/ir.model.access.csv
```
**Check**: Does the user group have access to the model referenced by the action?
- Minimum: Read access for `base.group_user`
- Without access rights, menu appears but clicking shows "Access Denied"

### 5. XML Structure Requirements (Odoo 18)
```xml
<!-- ‚úÖ CORRECT: menuitem tags must be direct children of <data> or <odoo> -->
<odoo>
  <menuitem id="menu_item" name="Item Name" parent="parent_id" action="action_id" sequence="10"/>
</odoo>

<!-- ‚ùå WRONG: menuitem nested inside <record> -->
<odoo>
  <record id="something" model="ir.model">
    <menuitem id="menu_item"/>  <!-- Will fail validation -->
  </record>
</odoo>
```

### 6. Required Attributes
Every menuitem MUST have:
- `id="..."` - Unique identifier (used by other menus as parent)
- `name="..."` - Display name (shown in UI)
- Either:
  - `action="..."` - For leaf menus (opens a view)
  - OR child menuitems - For parent menus (creates submenu)
- Optional but recommended:
  - `parent="..."` - Parent menu id (omit only for root-level menus)
  - `sequence="..."` - Display order (defaults to 10)

### 7. Common Mistakes to Avoid

**Mistake 1: Action vs View Confusion**
```xml
<!-- ‚ùå WRONG -->
<menuitem action="view_pharmaceutical_charge_tree"/>

<!-- ‚úÖ CORRECT -->
<menuitem action="action_pharmaceutical_charge"/>
<!-- Where action_pharmaceutical_charge is an ir.actions.act_window -->
```

**Mistake 2: Missing Parent**
```xml
<!-- ‚ùå WRONG: Parent doesn't exist yet -->
<menuitem id="child_menu" parent="menu_not_yet_defined" action="..."/>

<!-- ‚úÖ CORRECT: Define parent first, or reference existing parent -->
<menuitem id="menu_not_yet_defined" name="Parent Menu"/>
<menuitem id="child_menu" parent="menu_not_yet_defined" action="..."/>
```

**Mistake 3: Wrong File Loading Order**
```python
# ‚ùå WRONG in __manifest__.py:
"data": [
    "views/menu.xml",  # Loads menu FIRST (references actions that don't exist yet)
    "views/pharmaceutical_charge_views.xml",  # Defines actions LATER
]

# ‚úÖ CORRECT:
"data": [
    "views/pharmaceutical_charge_views.xml",  # Define actions FIRST
    "views/menu.xml",  # Reference actions LAST
]
```

### 8. Validation Workflow
```bash
# After creating/editing menuitem XML:

# Step 1: Validate dependencies
python3 scripts/validate_deps.py

# Step 2: Upgrade module
./restart_and_upgrade.sh

# Step 3: Check database
docker compose exec db psql -U odoo -d demo -c \
  "SELECT id, name::text, parent_id, action FROM ir_ui_menu WHERE name::text LIKE '%YourMenu%';"

# Step 4: Verify in UI
# Navigate to menu location and click - should open without errors

# Step 5: Check menu hierarchy
python3 scripts/validate_menu_hierarchy.py
```

### 9. Odoo 18 Specific: JSONB Fields
```sql
-- ‚ùå WRONG: Comparing JSONB field directly
SELECT * FROM ir_ui_menu WHERE name LIKE '%Pharmaceutical%';
-- Error: operator does not exist: jsonb ~~ unknown

-- ‚úÖ CORRECT: Cast JSONB to text first
SELECT * FROM ir_ui_menu WHERE name::text LIKE '%Pharmaceutical%';
```

### Quick Checklist (Copy/Paste Before Creating Menus)
```
‚ñ° Action id exists and is defined before menu file loads?
‚ñ° Parent menu id exists in database or is defined earlier?
‚ñ° Sequence number fits logically with siblings?
‚ñ° Security access rights exist for the referenced model?
‚ñ° menuitem is direct child of <data> or <odoo> tag?
‚ñ° All required attributes present (id, name, action OR children)?
‚ñ° File loads in correct position in __manifest__.py?
‚ñ° Ran python3 scripts/validate_deps.py?
‚ñ° Ran ./restart_and_upgrade.sh successfully?
‚ñ° Verified menu appears in database with correct parent_id?
‚ñ° Verified menu visible and clickable in UI?
```

**Reference**: Phase 2 Pharmaceutical Menus Implementation (October 2025)
- 50+ failed attempts by not following this checklist
- Success achieved by validating all fundamentals BEFORE creating XML

---

## üîç MENU HIERARCHY VALIDATION (Critical for Menu Visibility)

### The Silent Bug: Corrupted parent_path
Odoo menus can exist in the database but be INVISIBLE in the UI due to corrupted `parent_path` values. **Odoo has NO built-in validation for this.**

### What is parent_path?
- Field in `ir_ui_menu` table: stores hierarchical path (e.g., `226/247/248/`)
- Used by PostgreSQL's `child_of` operator for efficient hierarchical queries
- Powers `load_menus()` API that builds the menu tree for the web client
- **If corrupted, menus silently disappear from UI with NO error logs**

### Common Causes:
1. **Deleted parent menus** - Child menus still reference the deleted ID in parent_path
2. **Manual SQL updates** - Changing parent_id without updating parent_path
3. **Module uninstall/reinstall** - Sometimes fails to recalculate paths
4. **Database migrations** - parent_path can become stale

### How to Detect:
```bash
# Run validation script (checks all 233+ menus in your system)
python3 scripts/validate_menu_hierarchy.py

# Manual check in PostgreSQL (if menu ID 247 is missing):
docker compose exec db psql -U odoo -d npo -c \
  "SELECT id, name, parent_id, parent_path FROM ir_ui_menu WHERE id = 247;"

# Check if child_of operator works:
docker compose exec odoo odoo shell -d npo --stop-after-init << 'EOF'
env['ir.ui.menu'].search([('id', 'child_of', [226])])  # Should find ALL children
exit()
EOF
```

### How to Fix:
```sql
-- Example: Fix menu 247 whose parent is 226
-- Wrong: parent_path = '246/247/' (references deleted menu 246)
-- Correct: parent_path = '226/247/' (references actual parent 226)

docker compose exec db psql -U odoo -d npo -c \
  "UPDATE ir_ui_menu SET parent_path = '226/247/' WHERE id = 247;"

-- Fix child menus recursively:
docker compose exec db psql -U odoo -d npo -c \
  "UPDATE ir_ui_menu SET parent_path = '226/247/248/' WHERE id = 248;"

-- Restart to clear cache:
docker compose restart odoo
```

### Prevention:
1. **Never delete parent menus** - Disable them instead (`active = False`)
2. **Run validation after module changes**:
   ```bash
   # Add to your workflow:
   python3 scripts/validate_menu_hierarchy.py
   ```
3. **Check menu visibility immediately** after:
   - Module upgrade with new menus
   - Database restore
   - Manual SQL changes to ir_ui_menu
   - Deleting/uninstalling modules

### Symptoms:
- ‚ùå Menu exists in database (`SELECT * FROM ir_ui_menu WHERE id = X`)
- ‚ùå Direct URL works (`/web#action=390`)
- ‚ùå Model is accessible in Python (`env['model.name'].search([])`)
- ‚ùå But menu is INVISIBLE in UI navigation
- ‚ùå `load_menus()` doesn't return it
- ‚ùå NO error logs anywhere

### Real Example (October 2025):
Phase 3 Procurement menus had parent_path = `246/247/` but menu 246 was deleted.
- All 5 menus existed in database ‚úÖ
- All had correct `parent_id` ‚úÖ  
- All were `active = True` ‚úÖ
- But they were INVISIBLE in UI ‚ùå
- Fixed by correcting parent_path to reference actual parent (226)

### Validation Script Location:
`/home/chirpydog/odoo-dev-2/scripts/validate_menu_hierarchy.py`

**Run this after ANY menu changes or module upgrades!**

### Documentation:
Full postmortem with detailed analysis: `README/PHASE3_MENU_FIX_POSTMORTEM.md`

---

## üé® ODOO 18 WEB CLIENT RENDERING ISSUES

### Browser Layout Reflow Bug (November 2025)

**Symptom**: Form views with complex layouts (notebooks, HTML widgets, one2many lists, chatter sections) may render with narrow/collapsed columns on initial page load. Opening browser DevTools (F12) or resizing the window fixes the layout temporarily.

**Root Cause**: Browser fails to calculate correct flexbox widths when:
- Notebook pages with conditional visibility load dynamic content
- Large HTML widgets (like import summaries) change layout after mount
- Chatter sections (activities/messages) have nested flex containers
- Odoo JS doesn't trigger window resize event after mounting complex widgets

**Example Models Affected**:
- `nh.mail.subsidy.handler` - Email import history forms with HTML summaries and chatter

**Solution**: Apply **dual fix** (CSS + JS) to force proper layout calculation:

#### 1. CSS Fix (Preferred - Most Reliable)
Create `static/src/css/model_name_fix.css`:
```css
/* Prevent chatter column collapse */
body .o_form_view[data-res-model="your.model.name"] .oe_chatter .o_chatter_header,
body .o_form_view[data-res-model="your.model.name"] .oe_chatter .o_mail_thread {
    width: 100% !important;
    min-width: 0 !important;
}

/* Ensure activities/messages don't collapse */
body .o_form_view[data-res-model="your.model.name"] .oe_chatter .o_mail_activity,
body .o_form_view[data-res-model="your.model.name"] .oe_chatter .o_Message {
    width: 100%;
}
```

#### 2. JS Fix (Backup - Forces Reflow)
Create `static/src/js/model_name_fix.js`:
```javascript
/** @odoo-module **/
import { onMounted } from "@odoo/owl";
import { FormController } from "@web/views/form/form_controller";
import { patch } from "@web/core/utils/patch";

patch(FormController.prototype, {
    setup() {
        super.setup(...arguments);
        onMounted(() => {
            if (this.props.resModel === 'your.model.name') {
                // Strategy 1: Window resize
                setTimeout(() => window.dispatchEvent(new Event('resize')), 50);
                
                // Strategy 2: Chatter display toggle
                setTimeout(() => {
                    const chatter = document.querySelector('.oe_chatter');
                    if (chatter) {
                        chatter.style.display = 'none';
                        chatter.offsetHeight; // Force reflow
                        chatter.style.display = '';
                    }
                }, 100);
            }
        });
    }
});
```

#### 3. Register Assets in `__manifest__.py`
```python
"assets": {
    "web.assets_backend": [
        "module_name/static/src/css/model_name_fix.css",
        "module_name/static/src/js/model_name_fix.js",
    ],
},
```

#### 4. Testing
After applying fix:
1. Hard refresh browser: `Cmd+Shift+R` (Mac) or `Ctrl+Shift+F5` (Windows)
2. Clear browser cache completely
3. Log out and log back in
4. Open affected form view - should render correctly without DevTools

**Why Both CSS and JS?**
- **CSS**: Prevents initial collapse (most reliable, no timing issues)
- **JS**: Forces reflow if CSS isn't enough (handles dynamic content changes)
- Together they cover all edge cases across browsers (Chrome, Firefox, Safari)

**Reference Implementation**: 
- **File**: `custom-addons/nh_billing/static/src/css/mail_handler_fix.css`
- **File**: `custom-addons/nh_billing/static/src/js/mail_handler_view_fix.js`
- **Model**: `nh.mail.subsidy.handler`
- **Issue**: Chatter activities/messages section collapsed to narrow left column on initial render
- **Symptom**: Left column barely visible (2-3px wide), DevTools (F12) fixes it temporarily
- **Browser Tested**: Safari on macOS (Sonoma 14.x)
- **Fix Verified**: Hard refresh + cache clear + logout/login ‚Üí Layout renders correctly
- **Fix Date**: November 2, 2025
- **Commit**: `fix: Resolve chatter layout collapse in mail.subsidy.handler forms (Odoo 18 CE rendering bug)`

**When to Use This Fix**:
- ‚úÖ Form has chatter (`mail.thread`, `mail.activity.mixin`)
- ‚úÖ Form has notebooks with conditional visibility
- ‚úÖ Form has HTML widgets with dynamic content
- ‚úÖ Layout looks correct when DevTools open, broken when closed
- ‚úÖ Hard refresh doesn't fix the issue

**Alternative (If Fix Doesn't Work)**:
- Simplify view: Move HTML widgets outside notebooks
- Reduce nested groups: Flatten layout structure
- Remove conditional visibility: Use `invisible` sparingly

---

## ÔøΩ EMAIL TEMPLATE CUSTOMIZATION (Odoo 18)

### The noupdate Protection Problem

Odoo's core email templates (mail module, sale module, etc.) have `noupdate="1"` protection, which prevents XML `<record>` tags from overriding existing database records during module upgrades.

**Symptoms**:
- ‚úÖ XML inheritance with `<template inherit_id="...">` creates records but doesn't affect existing emails
- ‚úÖ `<record>` tags with `forcecreate="False"` or `noupdate="0"` are ignored for already-installed templates
- ‚ùå Changes to email body or footer don't appear after module upgrade
- ‚ùå No error logs - upgrade succeeds but template unchanged in database

### Solution: Use `<function>` Tag to Force Database Updates

**Wrong Approach** (Doesn't work for existing templates):
```xml
<!-- ‚ùå IGNORED - Template already exists in DB with noupdate=1 -->
<record id="sale.email_template_edi_sale" model="mail.template" forcecreate="False">
    <field name="body_html" type="html">
        <!-- Your custom HTML -->
    </field>
</record>

<!-- ‚ùå CREATES NEW VIEW - Doesn't modify existing email layout -->
<template id="custom_layout" inherit_id="mail.mail_notification_layout">
    <xpath expr="//div[@class='footer']" position="replace">
        <!-- Your changes -->
    </xpath>
</template>
```

**Correct Approach** (Bypasses noupdate protection):
```xml
<!-- ‚úÖ WORKS - Directly calls write() method on the template -->
<function model="mail.template" name="write">
    <value eval="[ref('sale.email_template_edi_sale')]"/>
    <value eval="{'body_html': '''&lt;div&gt;Your custom HTML&lt;/div&gt;'''}"/>
</function>
```

### Email Footer Customization

**Problem**: Footer below signature (company info + "Powered by Odoo") defined in `mail.mail_notification_layout` template.

**Location**: `/usr/lib/python3/dist-packages/odoo/addons/mail/data/mail_templates_email_layouts.xml`

**Solution**: Use `<function>` to override the entire template `arch` field.

#### Step 1: Get Original Template
```bash
# Copy original template from container
docker exec $(docker compose ps -q odoo) cat \
  /usr/lib/python3/dist-packages/odoo/addons/mail/data/mail_templates_email_layouts.xml \
  > original_layout.xml
```

#### Step 2: Create Override with Modifications
File: `custom-addons/your_module/views/email_layout_override.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Use function to bypass noupdate protection -->
    <function model="ir.ui.view" name="write">
        <value eval="[ref('mail.mail_notification_layout')]"/>
        <value eval="{'arch': '''&lt;html t-att-lang=&quot;lang&quot;&gt;
&lt;head&gt;
    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html charset=UTF-8&quot; /&gt;
&lt;/head&gt;
&lt;body style=&quot;font-family:Verdana, Arial,sans-serif; color: #454748;&quot;&gt;
&lt;!-- ... full template content with your modifications ... --&gt;

&lt;!-- REMOVE FOOTER: Simply omit the footer div sections --&gt;
&lt;!-- Original had these lines (lines 94-106 in original):
&lt;div t-if=&quot;show_footer&quot; style=&quot;margin-top:16px;&quot;&gt;
    &lt;hr .../&gt;
    &lt;b t-out=&quot;company.name&quot; .../&gt;
    &lt;p&gt;company contact info&lt;/p&gt;
&lt;/div&gt;
&lt;div t-if=&quot;show_footer&quot;&gt;
    Powered by Odoo...
&lt;/div&gt;
--&gt;

&lt;/body&gt;&lt;/html&gt;'''}"/>
    </function>
</odoo>
```

#### Step 3: XML Entity Escaping Rules

When using `<function>` with eval strings containing HTML:

**Required Escapes**:
- `<` ‚Üí `&lt;`
- `>` ‚Üí `&gt;`
- `"` ‚Üí `&quot;`
- `&` ‚Üí `&amp;`
- Non-breaking space: Use `&#160;` **NOT** `&nbsp;` (causes "Entity 'nbsp' not defined" error)

**Example**:
```xml
<!-- ‚ùå WRONG - Causes ParseError -->
<value eval="{'arch': '''&lt;td&gt;&amp;nbsp;&amp;nbsp;&lt;/td&gt;'''}"/>

<!-- ‚úÖ CORRECT -->
<value eval="{'arch': '''&lt;td&gt;&amp;#160;&amp;#160;&lt;/td&gt;'''}"/>
```

#### Step 4: Update Manifest
Add dependency and data file in correct order:

```python
# custom-addons/your_module/__manifest__.py
{
    "name": "Your Module",
    "depends": ["sale", "account", "mail"],  # Add "mail" dependency
    "data": [
        "views/other_views.xml",
        "data/email_template_data.xml",  # Email body overrides (if any)
        "views/email_layout_override.xml",  # Email layout overrides LAST
    ],
}
```

#### Step 5: Apply Changes
```bash
# Restart Odoo to load new XML
docker compose restart odoo

# Upgrade module in UI
# Apps ‚Üí Update Apps List ‚Üí Search module ‚Üí Upgrade

# Test by sending quotation email
```

### Common Customizations

#### Remove "Powered by Odoo" Only
In the template arch, find and remove/replace:
```xml
&lt;div t-if=&quot;show_footer&quot; style=&quot;color: #555555; font-size:11px;&quot;&gt;
    Powered by &lt;a target=&quot;_blank&quot; href=&quot;https://www.odoo.com...&quot;&gt;Odoo&lt;/a&gt;
    ...
&lt;/div&gt;
```

#### Remove All Footer (Company Info + Powered By)
Omit both footer `<div t-if="show_footer">` sections from the template.

#### Custom Footer Message
Replace the "Powered by Odoo" section:
```xml
&lt;div t-if=&quot;show_footer&quot; style=&quot;color: #555555; font-size:11px;&quot;&gt;
    &amp;#169; &lt;t t-out=&quot;datetime.datetime.now().year&quot;/&gt; &lt;t t-out=&quot;company.name&quot;/&gt; - All rights reserved
&lt;/div&gt;
```

### File Structure Best Practices

```
custom-addons/your_module/
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ email_template_data.xml     # Email BODY overrides (function approach)
‚îú‚îÄ‚îÄ views/
‚îÇ   ‚îú‚îÄ‚îÄ other_views.xml
‚îÇ   ‚îî‚îÄ‚îÄ email_layout_override.xml   # Email LAYOUT overrides (function approach)
‚îî‚îÄ‚îÄ __manifest__.py
```

**Why separate files?**
- `data/` = Data modifications (mail.template records - email content/subject)
- `views/` = View modifications (ir.ui.view records - email layout/footer)
- Clearer intent for future developers

### Debugging Tips

**Template not updating after upgrade?**
1. Check if template exists: `docker compose exec db psql -U odoo -d postgres -c "SELECT id, name FROM mail_template WHERE name LIKE '%quotation%';"`
2. Check if view exists: `docker compose exec db psql -U odoo -d postgres -c "SELECT id, name FROM ir_ui_view WHERE name LIKE '%notification_layout%';"`
3. Check module is installed: Apps ‚Üí Installed (remove default filter)
4. Check Odoo logs: `docker compose logs odoo --tail=50 | grep -i error`
5. Force cache clear: Restart Odoo + hard refresh browser (Ctrl+Shift+R)

**Still not working?**
- Verify `<function>` syntax (must have exact model name)
- Verify `ref('module.template_id')` resolves (template must exist)
- Check for XML parsing errors in logs
- Try `forcecreate="True"` in manifest data section (rare cases)

### References

**Implementation Example**:
- **Module**: `custom-addons/sale_order_label_override`
- **Files**: 
  - `data/email_template_data.xml` - Quotation email body override
  - `views/email_layout_override.xml` - Email footer removal
- **Date**: January 7, 2026
- **Issue**: "Powered by Odoo" footer remained after XML inheritance approach
- **Solution**: Used `<function>` tag to directly write to `ir.ui.view.arch` field
- **Commit**: "feat: Remove email footer from quotation emails using function override"

**Original Odoo Templates**:
- Email layouts: `/usr/lib/python3/dist-packages/odoo/addons/mail/data/mail_templates_email_layouts.xml`
- Sale templates: `/usr/lib/python3/dist-packages/odoo/addons/sale/data/mail_template_data.xml`

---

## ÔøΩüìã DEPLOYMENT CHECKLIST

Before committing module changes:
1. ‚úÖ Run dependency validation: `python3 scripts/validate_deps.py`
2. ‚úÖ Run menu validation: `python3 scripts/validate_menu_hierarchy.py`
3. ‚úÖ Test module upgrade: `docker compose exec odoo odoo -d npo -u module_name --stop-after-init`
4. ‚úÖ Check UI: Verify all menus visible
5. ‚úÖ Check logs: `docker compose logs odoo | grep -i error`

---